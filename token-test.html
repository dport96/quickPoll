<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickPoll Token URL Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .example { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .code { background: #e8e8e8; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>QuickPoll URL Token Functionality Test</h1>
    
    <div class="example">
        <h2>üß™ Test the New Token-in-URL Feature</h2>
        <p>This page demonstrates how QuickPoll now supports GitHub tokens in URL parameters.</p>
        
        <h3>1. Manual Token Setting (Console)</h3>
        <div class="code">
            app.setGitHubToken("your_github_token_here");
        </div>
        
        <h3>2. URL Token Examples</h3>
        <p>When you create a poll, URLs like these are automatically generated:</p>
        <div class="code">
            http://localhost:8080/?mode=vote&id=GIST_ID&token=YOUR_TOKEN<br>
            http://localhost:8080/?mode=results&id=GIST_ID&token=YOUR_TOKEN
        </div>
        
        <h3>3. Test URL (Replace with your token)</h3>
        <div class="code">
            <a href="/?token=REPLACE_WITH_YOUR_TOKEN" target="_blank">
                Test Token Loading from URL
            </a>
        </div>
        
        <h3>4. Check Current Status</h3>
        <button onclick="checkStatus()">Check Token Status</button>
        <div id="status" style="margin-top: 10px;"></div>
    </div>

    <div class="example">
        <h2>üìù Quick Setup Instructions</h2>
        <ol>
            <li>Go to <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings ‚Üí Personal Access Tokens</a></li>
            <li>Click "Generate new token (classic)"</li>
            <li>Give it a name like "QuickPoll Access"</li>
            <li>Select the <strong>"gist"</strong> scope</li>
            <li>Click "Generate token" and copy it</li>
            <li>Use it in console: <code>app.setGitHubToken("your_token")</code></li>
        </ol>
    </div>

    <div class="example">
        <h2>üîç Testing Functions</h2>
        <button onclick="runQuickTest()">Quick Gist Test</button>
        <button onclick="runFullTest()">Full Test Suite</button>
        <button onclick="clearToken()">Clear Token</button>
        <div id="test-output" style="margin-top: 10px; white-space: pre-wrap; font-family: monospace;"></div>
    </div>

    <script>
        function checkStatus() {
            const status = document.getElementById('status');
            
            if (typeof window.app === 'undefined') {
                status.innerHTML = '<span class="error">‚ùå App not loaded yet - wait for page to fully load</span>';
                return;
            }
            
            const tokenInURL = new URLSearchParams(window.location.search).get('token');
            const hasToken = window.app.githubToken && window.app.githubToken !== 'GITHUB_TOKEN_NOT_SET';
            const isValid = window.app.isTokenValid && window.app.isTokenValid();
            
            let html = '<h4>Status Check:</h4>';
            html += `<p>Token in URL: ${tokenInURL ? '<span class="success">‚úÖ Found</span>' : '<span class="warning">‚ö†Ô∏è None</span>'}</p>`;
            html += `<p>Token in App: ${hasToken ? '<span class="success">‚úÖ Set</span>' : '<span class="error">‚ùå Not Set</span>'}</p>`;
            html += `<p>Token Valid: ${isValid ? '<span class="success">‚úÖ Valid</span>' : '<span class="error">‚ùå Invalid</span>'}</p>`;
            
            if (hasToken) {
                const preview = window.app.githubToken.substring(0, 10) + '...';
                html += `<p>Token Preview: <code>${preview}</code> (${window.app.githubToken.length} chars)</p>`;
            }
            
            status.innerHTML = html;
        }
        
        function runQuickTest() {
            const output = document.getElementById('test-output');
            output.textContent = 'Running quick test...\n';
            
            if (typeof quickGistTest === 'function') {
                // Capture console output
                const originalLog = console.log;
                let logs = '';
                console.log = function(...args) {
                    logs += args.join(' ') + '\n';
                    originalLog.apply(console, arguments);
                };
                
                quickGistTest();
                
                console.log = originalLog;
                output.textContent = logs;
            } else {
                output.textContent = 'Error: Test functions not loaded';
            }
        }
        
        function runFullTest() {
            const output = document.getElementById('test-output');
            output.textContent = 'Running full test suite...\n';
            
            if (typeof testGistStorage === 'function') {
                testGistStorage().then(result => {
                    output.textContent += `\nTest completed: ${result.passed}/${result.total} passed in ${result.duration}ms`;
                }).catch(error => {
                    output.textContent += `\nTest failed: ${error.message}`;
                });
            } else {
                output.textContent = 'Error: Test functions not loaded';
            }
        }
        
        function clearToken() {
            if (window.app && window.app.clearGitHubToken) {
                window.app.clearGitHubToken();
                checkStatus();
            }
        }
        
        // Auto-check status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkStatus, 1000); // Wait for app to initialize
        });
    </script>
    
    <!-- Load the actual app -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="email-auth-styles.css">
    <script src="email-auth-script.js"></script>
    <script src="github-gist-script.js"></script>
    <script src="gist-storage-test.js"></script>
</body>
</html>
