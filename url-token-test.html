<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Token Test - QuickPoll</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .test-section { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .code-snippet { background: #f1f3f4; border-left: 4px solid #667eea; padding: 15px; margin: 10px 0; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <h1>üîç URL Token Loading Test</h1>
    
    <div class="test-section">
        <h3>Current URL Analysis</h3>
        <div id="url-analysis"></div>
    </div>

    <div class="test-section">
        <h3>Token Loading Test</h3>
        <div id="token-test"></div>
    </div>

    <div class="test-section">
        <h3>Debug Steps</h3>
        <div id="debug-steps"></div>
    </div>

    <script>
        function analyzeURL() {
            const urlAnalysis = document.getElementById('url-analysis');
            const currentURL = window.location.href;
            const params = new URLSearchParams(window.location.search);
            
            urlAnalysis.innerHTML = `
                <div class="code-snippet">
                    <strong>Full URL:</strong><br>${currentURL}<br><br>
                    <strong>Parameters:</strong><br>
                    mode: ${params.get('mode')}<br>
                    id: ${params.get('id')}<br>
                    token: ${params.get('token') ? 'Present (' + params.get('token').substring(0, 20) + '...)' : 'Missing'}<br>
                    github_token: ${params.get('github_token') ? 'Present' : 'Missing'}
                </div>
            `;
        }

        function testTokenLoading() {
            const tokenTest = document.getElementById('token-test');
            
            // Simulate the token loading logic from the app
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromURL = urlParams.get('token') || urlParams.get('github_token');
            
            let validationResult = 'Unknown';
            if (tokenFromURL) {
                const isClassicToken = tokenFromURL.startsWith('ghp_') && tokenFromURL.length >= 36;
                const isFineGrainedToken = tokenFromURL.startsWith('github_pat_') && tokenFromURL.length >= 50;
                validationResult = isClassicToken || isFineGrainedToken ? 'Valid format' : 'Invalid format';
            }
            
            tokenTest.innerHTML = `
                <div class="code-snippet">
                    <strong>Token Found:</strong> ${tokenFromURL ? 'Yes' : 'No'}<br>
                    ${tokenFromURL ? `<strong>Token Type:</strong> ${tokenFromURL.startsWith('ghp_') ? 'Classic (ghp_)' : tokenFromURL.startsWith('github_pat_') ? 'Fine-grained (github_pat_)' : 'Unknown'}<br>` : ''}
                    ${tokenFromURL ? `<strong>Token Length:</strong> ${tokenFromURL.length}<br>` : ''}
                    <strong>Validation:</strong> ${validationResult}
                </div>
            `;
        }

        function debugSteps() {
            const debugSteps = document.getElementById('debug-steps');
            
            debugSteps.innerHTML = `
                <ol>
                    <li><strong>Check URL Parameters:</strong> Mode and ID should be present</li>
                    <li><strong>Check Token:</strong> Token should be valid format and length</li>
                    <li><strong>Constructor Flow:</strong> 
                        <ul>
                            <li>super() called</li>
                            <li>loadTokenFromURL() checks URL</li>
                            <li>setGitHubToken() validates and stores</li>
                            <li>cleanTokenFromURL() removes from URL</li>
                        </ul>
                    </li>
                    <li><strong>Async Initialization:</strong>
                        <ul>
                            <li>parseQueryString() detects mode/ID</li>
                            <li>loadPollFromParams() called</li>
                            <li>loadPollFromGitHub() uses stored token</li>
                        </ul>
                    </li>
                </ol>
                
                <h4>Potential Issues:</h4>
                <ul>
                    <li>‚ùå Token validation fails silently</li>
                    <li>‚ùå Token cleaned from URL before it's properly stored</li>
                    <li>‚ùå Race condition in async loading</li>
                    <li>‚ùå Error in GitHub API call not properly handled</li>
                </ul>
            `;
        }

        // Run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            analyzeURL();
            testTokenLoading();
            debugSteps();
        });
    </script>
</body>
</html>
